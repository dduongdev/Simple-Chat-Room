package entities;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.net.Socket;
import java.util.Scanner;

public class Client {
	private static int port = 8080;
	private static String hostname = "localhost";
	private static volatile boolean inUse = false;
	private static Object lock = new Object();
	
	public static void main(String[] args) {
		Scanner sc = new Scanner(System.in);
		
		try {
			Socket socket = new Socket(hostname, port);
			inUse = true;
			
			System.out.println("Notice: Send '--exit' to exit chat room.");
			System.out.print("Enter usename: ");
			String username = sc.nextLine();
			
			Thread retrieveMessage = new Thread(new Runnable() {
				@Override
				public void run() {
					try (BufferedReader reader = new BufferedReader(new InputStreamReader(socket.getInputStream()))) {
						String message = "";
						while(true) {
							synchronized(lock) {
								if(inUse && (message == reader.readLine()) != null) {
									System.out.println(message);
								}
							}
						}
					} catch(IOException | InterruptedException e) {
						e.printStackTrace();
					}
				}
			});
			retrieveMessage.start();
			
			PrintWriter writer = new PrintWriter(socket.getOutputStream());
			String message = "";
			while(true) {
				message = sc.nextLine();
				if(message.trim().equals("exit")) {
					synchronized (lock) {
						inUse = false;
						System.out.println("OK");
					}
					break;
				}
				
				message = username + " " + message + "\n";
				writer.println(message);
			}
			
			socket.close();
			sc.close();
		} catch(IOException e) {
			e.printStackTrace();
		}
	}
}
